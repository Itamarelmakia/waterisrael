# prompts.py
from __future__ import annotations

# -----------------------------------------
# Allowed outputs (canonical labels - exact spelling)
# -----------------------------------------
ALLOWED_FUNDING_LABELS = {
    "שיקום/שדרוג",
    "פיתוח",
    "תשתית ביוב אזורית",
    "קידוחים",
    "תחזוקה / שוטף",
}


# -----------------------------------------
# Canonical mapping: "נושא" -> "מקור מימון"
# Fill this dict with ALL rows from your guidance document.
# -----------------------------------------
SUBJECT_TO_ALLOWED: dict[str, set[str]] = {
    "הורדת לחצים / חלוקה לאזורי מדידה / הוספת מגופי שליטה (כולל אביזרים וצנרת)": {"שיקום/שדרוג", "פיתוח"},
    "חיבורי צרכן של מקורות": {"שיקום/שדרוג", "פיתוח"},
    "פרויקט התקנות מערכות מדידה לקו ביוב גרביטציוני": {"שיקום/שדרוג", "פיתוח"},
    "ציוד לתחנות מים וביוב": {"שיקום/שדרוג", "פיתוח"},
    "החלפת משאבות מים / ביוב": {"שיקום/שדרוג"},
    "קווי סניקה (לביוב)": {"שיקום/שדרוג", "פיתוח"},
    "שיקום בריכות": {"שיקום/שדרוג"},
    "הסדרת שטח – הנדסה אזרחית": {"שיקום/שדרוג", "פיתוח"},
    "הסדרת דרך – הנדסה אזרחית": {"שיקום/שדרוג", "פיתוח"},
    "הסדרת חצר מתקן": {"שיקום/שדרוג", "פיתוח"},
    "החלפת לוח חשמל": {"שיקום/שדרוג"},
    "פיקוד מרחוק": {"שיקום/שדרוג", "פיתוח"},
    "תחנת שאיבה – שיקום צנרת": {"שיקום/שדרוג", "פיתוח"},
    "תחנת שאיבה – החלפת מבנה": {"שיקום/שדרוג"},
    "מתקני חיטוי": {"שיקום/שדרוג", "פיתוח"},
    "מתקני חיטוי בקידוח": {"קידוחים"},
    "מתקני קדם-טיפול לביוב (כולל ניטרול ריחות) במתקן טיהור שפכים (מט\"ש)": {"תשתית ביוב אזורית"},
    "מתקני קדם-טיפול לביוב (כולל ניטרול ריחות)": {"שיקום/שדרוג", "פיתוח"},
    "קווים קצרים – מים / ביוב": {"שיקום/שדרוג", "פיתוח"},
    "קידוחים": {"קידוחים"},
    "מט\"ש - מתקן טיהור שפכים": {"תשתית ביוב אזורית"},
    "מערכת אזורית של ביוב – קווים ותחנות שאיבה": {"תשתית ביוב אזורית"},
    "מתקנים במתקן טיהור שפכים (מט\"ש)": {"תשתית ביוב אזורית"},

    # --- תחזוקה / שוטף (מזוהה אבל "לא שייך לתוכנית השקעה") ---
    "צילום ושטיפת קווי ביוב": {"תחזוקה / שוטף"},
    "הכנת מסד נתונים למימוש מערכת GIS": {"תחזוקה / שוטף"},
    "החלפת מפוחים שונים": {"תחזוקה / שוטף"},
    "תכניות אב למים ולביוב": {"תחזוקה / שוטף"},
    "מדידות של מפלסי מים וביוב, ניתור מערכות קבועות, פיקוד ובקרה": {"תחזוקה / שוטף"},
    "רכישת ציוד לבקרה וניטור": {"תחזוקה / שוטף"},
    "סייבר – תכנית BCP, המשכיות עסקית, התאמות רגולטוריות, השלמת שערים לפי 7001, הקשחות אבטחת חדר שרתים ועוד": {"תחזוקה / שוטף"},
    "קריאה מרחוק (קר\"מ)": {"תחזוקה / שוטף"},
    "שיקום תחנות דיגום ציבורי": {"תחזוקה / שוטף"},
    "לכידת אבנית": {"תחזוקה / שוטף"},
    "החלפת מדי מים בקטרים \"1.5–6\"": {"תחזוקה / שוטף"},
    "סקר עלויות אנרגיה": {"תחזוקה / שוטף"},
    "סקר חיבורי ניקוז גגות למערכת ביוב": {"תחזוקה / שוטף"},
    "סקר חיבורי ניקוז גגות בבתים פרטיים": {"תחזוקה / שוטף"},
    "סקר גניבת איכות מים": {"תחזוקה / שוטף"},
    "סקר בדיקות קווים ברשת המים": {"תחזוקה / שוטף"},
    "הפרדת ביוב": {"תחזוקה / שוטף"},
    "סריקות הנדסיות, כולל מיפוי שליטה וניהול": {"תחזוקה / שוטף"},
    "רכישת ציוד חירום – מחסן ציוד ומילוי מחסן אביזרים": {"תחזוקה / שוטף"},
    "הגנה קתודית": {"תחזוקה / שוטף"},
}


# -----------------------------------------
# Synonyms / patterns -> canonical subject
# This helps deterministic matching before calling the LLM.
# Keys should be in normalized (lowercase-equivalent) form for Hebrew or used with normalize_text.
# Now maps directly to labels where unambiguous, or to subjects for SUBJECT_TO_ALLOWED lookup.
# EXPANDED: 100+ rules for maximum deterministic coverage
# -----------------------------------------
SUBJECT_SYNONYMS: dict[str, str] = {
    # =========================================
    # קידוחים / בארות (direct label -> קידוחים)
    # =========================================
    "באר": "קידוחים",
    "קידוח": "קידוחים",
    "קידוחים": "קידוחים",
    "רדיוס מגן": "קידוחים",
    "בארות": "קידוחים",
    "באר מים": "קידוחים",
    "קידוח מים": "קידוחים",
    "באר חדשה": "קידוחים",
    "קידוח חדש": "קידוחים",
    "שדה קידוחים": "קידוחים",

    # =========================================
    # מט"ש / טיהור שפכים (-> תשתית ביוב אזורית)
    # =========================================
    'מט"ש': 'מט"ש - מתקן טיהור שפכים',
    "מטש": 'מט"ש - מתקן טיהור שפכים',
    "מתקן טיהור שפכים": 'מט"ש - מתקן טיהור שפכים',
    "טיהור שפכים": 'מט"ש - מתקן טיהור שפכים',
    "מכון טיהור": 'מט"ש - מתקן טיהור שפכים',
    "מתקן טיהור": 'מט"ש - מתקן טיהור שפכים',
    "טיהור": 'מט"ש - מתקן טיהור שפכים',

    # =========================================
    # מאספים / הולכת שפכים אזורית (-> תשתית ביוב אזורית)
    # =========================================
    "מאסף אזורי": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",
    "מאסף ראשי": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",
    "מאסף חוצה": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",
    "מאסף ביוב אזורי": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",
    "מאסף ביוב ראשי": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",
    "קו הולכת שפכים": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",
    "קו הולכת ביוב": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",
    "הולכת שפכים": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",
    "קו הולכה אזורי": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",
    "קו ביוב אזורי": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",

    # =========================================
    # תחנות שאיבה / קווי סניקה
    # =========================================
    "תחנת שאיבה": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",
    "תחנת שאיבת ביוב": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",
    "תחנת שאיבת מים": "קווים קצרים – מים / ביוב",
    "תש\"ב": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",
    "תשב": "מערכת אזורית של ביוב – קווים ותחנות שאיבה",
    "תחנת בוסטרים": "קווים קצרים – מים / ביוב",
    "בוסטר": "קווים קצרים – מים / ביוב",
    "בוסטרים": "קווים קצרים – מים / ביוב",
    "קווי סניקה": "קווי סניקה (לביוב)",
    "קו סניקה": "קווי סניקה (לביוב)",
    "סניקה": "קווי סניקה (לביוב)",

    # =========================================
    # מאסף רגיל (לא אזורי) - קווים קצרים
    # =========================================
    "מאסף": "קווים קצרים – מים / ביוב",
    "מאסף ביוב": "קווים קצרים – מים / ביוב",
    "מאספים": "קווים קצרים – מים / ביוב",

    # =========================================
    # קווי מים/ביוב קצרים - infrastructure
    # =========================================
    "קווי ביוב": "קווים קצרים – מים / ביוב",
    "קו ביוב": "קווים קצרים – מים / ביוב",
    "קווי מים": "קווים קצרים – מים / ביוב",
    "קו מים": "קווים קצרים – מים / ביוב",
    "מערכת ביוב": "קווים קצרים – מים / ביוב",
    "מערכות ביוב": "קווים קצרים – מים / ביוב",
    "מערכת מים": "קווים קצרים – מים / ביוב",
    "מערכות מים": "קווים קצרים – מים / ביוב",
    "קו אספקה": "קווים קצרים – מים / ביוב",
    "קו אספקת מים": "קווים קצרים – מים / ביוב",
    "אספקת מים": "קווים קצרים – מים / ביוב",
    "קו הולכה": "קווים קצרים – מים / ביוב",
    "קו מוביל": "קווים קצרים – מים / ביוב",
    "קו ראשי": "קווים קצרים – מים / ביוב",
    "צנרת מים": "קווים קצרים – מים / ביוב",
    "צנרת ביוב": "קווים קצרים – מים / ביוב",
    "רשת מים": "קווים קצרים – מים / ביוב",
    "רשת ביוב": "קווים קצרים – מים / ביוב",

    # =========================================
    # שכונות / ותמ"ל / מתחמים / פרויקטים עירוניים
    # (These map to קווים קצרים which has 2-way ambiguity)
    # =========================================
    "שכונת": "קווים קצרים – מים / ביוב",
    "שכונה": "קווים קצרים – מים / ביוב",
    "ותמ\"ל": "קווים קצרים – מים / ביוב",
    'ותמ"ל': "קווים קצרים – מים / ביוב",
    "ותמל": "קווים קצרים – מים / ביוב",
    "מתחם": "קווים קצרים – מים / ביוב",
    "פינוי בינוי": "קווים קצרים – מים / ביוב",
    "תמא 38": "קווים קצרים – מים / ביוב",
    "תמ\"א 38": "קווים קצרים – מים / ביוב",
    "שלב א": "קווים קצרים – מים / ביוב",
    "שלב ב": "קווים קצרים – מים / ביוב",
    "שלב ג": "קווים קצרים – מים / ביוב",
    "שלב 1": "קווים קצרים – מים / ביוב",
    "שלב 2": "קווים קצרים – מים / ביוב",
    "השלמת מקטע": "קווים קצרים – מים / ביוב",
    "השלמה": "קווים קצרים – מים / ביוב",
    "באזורים שונים": "קווים קצרים – מים / ביוב",
    "מוקדים שונים": "קווים קצרים – מים / ביוב",
    "מפוזרים": "קווים קצרים – מים / ביוב",
    "שכונה מזרחית": "קווים קצרים – מים / ביוב",
    "שכונה דרומית": "קווים קצרים – מים / ביוב",
    "שכונה מערבית": "קווים קצרים – מים / ביוב",
    "שכונה צפונית": "קווים קצרים – מים / ביוב",

    # =========================================
    # החלפות / שיקום קלאסיים (-> שיקום/שדרוג only)
    # =========================================
    "החלפת משאבה": "החלפת משאבות מים / ביוב",
    "החלפת משאבות": "החלפת משאבות מים / ביוב",
    "משאבות": "החלפת משאבות מים / ביוב",
    "משאבה": "החלפת משאבות מים / ביוב",
    "החלפת לוח חשמל": "החלפת לוח חשמל",
    "לוח חשמל": "החלפת לוח חשמל",
    "שיקום בריכה": "שיקום בריכות",
    "בריכת מים": "שיקום בריכות",
    "בריכה": "שיקום בריכות",
    "בריכות": "שיקום בריכות",
    "בריכת אגירה": "שיקום בריכות",
    "מגדל מים": "שיקום בריכות",
    # Additional שיקום/שדרוג specific patterns
    "החלפת מוני מים": "החלפת מדי מים בקטרים \"1.5–6\"",  # -> תחזוקה
    "החלפת מדי מים": "החלפת מדי מים בקטרים \"1.5–6\"",  # -> תחזוקה
    "מגוף": "הורדת לחצים / חלוקה לאזורי מדידה / הוספת מגופי שליטה (כולל אביזרים וצנרת)",
    "מגופים": "הורדת לחצים / חלוקה לאזורי מדידה / הוספת מגופי שליטה (כולל אביזרים וצנרת)",
    "מגוף מכני": "הורדת לחצים / חלוקה לאזורי מדידה / הוספת מגופי שליטה (כולל אביזרים וצנרת)",

    # =========================================
    # מתקני חיטוי / קדם טיפול
    # =========================================
    "חיטוי": "מתקני חיטוי",
    "מתקן חיטוי": "מתקני חיטוי",
    "כלור": "מתקני חיטוי",
    "קדם טיפול": 'מתקני קדם-טיפול לביוב (כולל ניטרול ריחות)',
    "ניטרול ריחות": 'מתקני קדם-טיפול לביוב (כולל ניטרול ריחות)',

    # =========================================
    # פיקוד ובקרה / אוטומציה / מיגון
    # =========================================
    "פיקוד מרחוק": "פיקוד מרחוק",
    "מערכת בקרה": "פיקוד מרחוק",
    "מערכות בקרה": "פיקוד מרחוק",
    "פיקוד ובקרה": "פיקוד מרחוק",
    "מערכות מיגון": "פיקוד מרחוק",
    "מיגון": "פיקוד מרחוק",
    "אוטומציה": "פיקוד מרחוק",
    "סקאדה": "פיקוד מרחוק",
    "SCADA": "פיקוד מרחוק",

    # =========================================
    # תחזוקה/שוטף (לא שייך להשקעה)
    # =========================================
    "צילום": "צילום ושטיפת קווי ביוב",
    "שטיפה": "צילום ושטיפת קווי ביוב",
    "צילום קווים": "צילום ושטיפת קווי ביוב",
    "שטיפת קווים": "צילום ושטיפת קווי ביוב",
    "סקר": "סקר בדיקות קווים ברשת המים",
    "סקרים": "סקר בדיקות קווים ברשת המים",
    "מדידות": "מדידות של מפלסי מים וביוב, ניתור מערכות קבועות, פיקוד ובקרה",
    "מדידה": "מדידות של מפלסי מים וביוב, ניתור מערכות קבועות, פיקוד ובקרה",
    "תכנית אב": "תכניות אב למים ולביוב",
    "תכניות אב": "תכניות אב למים ולביוב",
    "GIS": "הכנת מסד נתונים למימוש מערכת GIS",
    "gis": "הכנת מסד נתונים למימוש מערכת GIS",
    "מסד נתונים": "הכנת מסד נתונים למימוש מערכת GIS",
    'קר"מ': 'קריאה מרחוק (קר"מ)',
    "קרמ": 'קריאה מרחוק (קר"מ)',
    "קריאה מרחוק": 'קריאה מרחוק (קר"מ)',
    "ניטור": "מדידות של מפלסי מים וביוב, ניתור מערכות קבועות, פיקוד ובקרה",
    "ניתור": "מדידות של מפלסי מים וביוב, ניתור מערכות קבועות, פיקוד ובקרה",

    # =========================================
    # הסדרות / הנדסה אזרחית
    # =========================================
    "הסדרת שטח": "הסדרת שטח – הנדסה אזרחית",
    "הסדרת דרך": "הסדרת דרך – הנדסה אזרחית",
    "הסדרת חצר": "הסדרת חצר מתקן",
    "הנדסה אזרחית": "הסדרת שטח – הנדסה אזרחית",

    # =========================================
    # לחצים / מדידה / מגופים
    # =========================================
    "הורדת לחצים": "הורדת לחצים / חלוקה לאזורי מדידה / הוספת מגופי שליטה (כולל אביזרים וצנרת)",
    "אזורי מדידה": "הורדת לחצים / חלוקה לאזורי מדידה / הוספת מגופי שליטה (כולל אביזרים וצנרת)",
    "מגופי שליטה": "הורדת לחצים / חלוקה לאזורי מדידה / הוספת מגופי שליטה (כולל אביזרים וצנרת)",
}


# -----------------------------------------
# LLM prompt builder (without subject)
# -----------------------------------------
def build_llm_prompt(project_name: str, *, allowed_set: set[str]) -> str:
    """Build LLM prompt for funding classification. No subject parameter."""
    allowed = " | ".join(sorted(allowed_set))
    lines = []
    lines.append("אתה מסווג פרויקט לפי מקור מימון. התשובה חייבת להיות JSON תקין בלבד, בלי טקסט נוסף.")
    lines.append('מבנה חובה: {"label": "...", "confidence": 0.0}')
    lines.append(f"label חייב להיות אחד בלבד מתוך: {allowed}")
    lines.append("confidence מספר בין 0 ל-1.")
    lines.append("")
    lines.append("רמזים:")
    lines.append("- אם זה חדש/הקמה/תוספת/הרחבה -> פיתוח")
    lines.append("- אם זה החלפה/שיקום/שדרוג/חידוש -> שיקום/שדרוג")
    lines.append("- אם זה מט\"ש/טיהור שפכים/שפכים/מאסף אזורי -> תשתית ביוב אזורית")
    lines.append("- אם זה באר/קידוח/רדיוס מגן -> קידוחים")
    lines.append("- אם זה צילום/שטיפה/סקר/מדידות/GIS/קר\"מ -> תחזוקה / שוטף")
    lines.append("")
    lines.append(f"שם פרויקט: {project_name}")
    lines.append("תשובה:")
    return "\n".join(lines)
