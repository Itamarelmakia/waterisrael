# prompts.py
from __future__ import annotations

# -----------------------------------------
# Allowed outputs (the LLM MUST return one)
# -----------------------------------------
#ALLOWED_FUNDING_LABELS = {"השקעה", "שיקום", "שיקום / שדרוג", "תחזוקה / שוטף"}
ALLOWED_FUNDING_LABELS = {"השקעה", "שיקום", "שיקום / שדרוג", "תחזוקה / שוטף", "קידוח"} # added "קידוח" - see rule 16


# -----------------------------------------
# Canonical mapping: "נושא" -> "מקור מימון"
# Fill this dict with ALL rows from your guidance document.
# -----------------------------------------
SUBJECT_TO_FUNDING: dict[str, str] = {
    # --- השקעה ---
    "הורדת לחצים / חלוקה לאזורי מדידה / הוספת מגופי שליטה (כולל אביזרים וצנרת)": "השקעה",
    "חיבורי צרכן של מקורות": "השקעה",
    "פרויקט התקנות מערכות מדידה לקו ביוב גרביטציוני": "השקעה",
    "ציוד לתחנות מים וביוב": "השקעה",
    "החלפת משאבות מים / ביוב": "השקעה",
    "קווי סניקה (לביוב)": "השקעה",
    "שיקום בריכות": "השקעה",
    "הסדרת שטח – הנדסה אזרחית": "השקעה",
    "הסדרת דרך – הנדסה אזרחית": "השקעה",
    "הסדרת חצר מתקן": "השקעה",
    "החלפת לוח חשמל": "השקעה",
    "פיקוד מרחוק": "השקעה",
    "תחנת שאיבה – שיקום צנרת": "השקעה",
    "תחנת שאיבה – החלפת מבנה": "השקעה",
    "מתקני חיטוי בקידוח": "השקעה",
    "מתקני קדם-טיפול לביוב (כולל ניטרול ריחות)": "השקעה",
    "קווים קצרים – מים / ביוב": "השקעה",
    "קידוחים": "השקעה",
    "מט\"ש - מתקן טיהור שפכים": "השקעה",
    "מערכת אזורית של ביוב – קווים ותחנות שאיבה": "השקעה",
    "מערכת אזורית של ביוב – קווים": "השקעה",
    "תחנות שאיבה אזוריות": "השקעה",
    "מתקן טיהור שפכים (מט\"ש)": "השקעה",

    # --- שיקום ---
    "מתקנים במתקן טיהור שפכים (מט\"ש)": "שיקום",

    # --- שיקום / שדרוג ---
    "קווי מים / ביוב קצרים": "שיקום / שדרוג",

    # --- תחזוקה / שוטף ---
    "צילום ושטיפת קווי ביוב": "תחזוקה / שוטף",
    "הכנת מסד נתונים למימוש מערכת GIS": "תחזוקה / שוטף",
    "החלפת מפוחים שונים": "תחזוקה / שוטף",
    "תכניות אב למים ולביוב": "תחזוקה / שוטף",
    "מדידות של מפלסי מים וביוב, ניתור מערכות קבועות, פיקוד ובקרה": "תחזוקה / שוטף",
    "רכישת ציוד לבקרה וניטור": "תחזוקה / שוטף",
    "סייבר – תכנית BCP, המשכיות עסקית, התאמות רגולטוריות, השלמת שערים לפי 7001, הקשחות אבטחת חדר שרתים ועוד": "תחזוקה / שוטף",
    "קריאה מרחוק (קר\"מ)": "תחזוקה / שוטף",
    "שיקום תחנות דיגום ציבורי": "תחזוקה / שוטף",
    "לכידת אבנית": "תחזוקה / שוטף",
    "החלפת מדי מים בקטרים \"1.5–6\"": "תחזוקה / שוטף",
    "סקר עלויות אנרגיה": "תחזוקה / שוטף",
    "סקר חיבורי ניקוז גגות למערכת ביוב": "תחזוקה / שוטף",
    "סקר חיבורי ניקוז גגות בבתים פרטיים": "תחזוקה / שוטף",
    "סקר גניבת איכות מים": "תחזוקה / שוטף",
    "סקר בדיקות קווים ברשת המים": "תחזוקה / שוטף",
    "הפרדת ביוב": "תחזוקה / שוטף",
    "סריקות הנדסיות, כולל מיפוי שליטה וניהול": "תחזוקה / שוטף",
    "רכישת ציוד חירום – מחסן ציוד ומילוי מחסן אביזרים": "תחזוקה / שוטף",
    "הגנה קתודית": "תחזוקה / שוטף",
}

# -----------------------------------------
# Optional: synonyms / patterns -> canonical subject
# This helps deterministic matching before calling the LLM.
# Keys and values should be in normalized form (or used with normalize_text).
# -----------------------------------------
SUBJECT_SYNONYMS: dict[str, str] = {
    # e.g. "באר ב - החלפת משאבה" should match the canonical subject below
    "החלפת משאבה": "החלפת משאבות מים / ביוב",
    "החלפת משאבות": "החלפת משאבות מים / ביוב",
}

# -----------------------------------------
# LLM prompt builder (uses the dict above)
# -----------------------------------------
def build_llm_prompt(project_name: str) -> str:
    allowed = " | ".join(["השקעה", "שיקום", "שיקום / שדרוג", "תחזוקה / שוטף"])

    lines: list[str] = []
    lines.append("אתה מסווג פרויקט לפי 'מקור מימון' בלבד.")
    lines.append(f"התשובה חייבת להיות JSON תקין בלבד, בלי טקסט נוסף.")
    lines.append("מבנה חובה: {\"label\": \"...\", \"confidence\": 0.0}")
    lines.append(f"label חייב להיות אחד בלבד מתוך: {allowed}")
    lines.append("confidence חייב להיות מספר בין 0 ל-1 (0=לא בטוח, 1=בטוח מאד).")
    lines.append("")
    lines.append("בחר את הנושא הקרוב ביותר מתוך הרשימה, ואז החזר את מקור המימון שלו.")
    lines.append("")
    lines.append("רשימת נושא -> מקור מימון:")
    for subj, fund in SUBJECT_TO_FUNDING.items():
        lines.append(f"- {subj} -> {fund}")
    lines.append("")
    lines.append(f"שם פרויקט: {project_name}")
    lines.append("תשובה:")

    return "\n".join(lines)
